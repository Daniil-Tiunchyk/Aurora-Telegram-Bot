package org.example;

import lombok.NoArgsConstructor;
import org.example.models.SupportRequest;
import org.example.models.UserInfo;
import org.example.services.SupportRequestService;
import org.example.services.UserInfoService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;
import org.telegram.telegrambots.meta.TelegramBotsApi;
import org.telegram.telegrambots.meta.api.methods.commands.SetMyCommands;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.api.objects.commands.BotCommand;
import org.telegram.telegrambots.meta.api.objects.commands.scope.BotCommandScopeDefault;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;
import org.telegram.telegrambots.updatesreceivers.DefaultBotSession;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.ConcurrentHashMap;

import jakarta.annotation.PostConstruct;

@Component
@NoArgsConstructor
public class NetworkingBot extends MultiSessionTelegramBot implements CommandLineRunner {

    private final ConcurrentHashMap<Long, DialogMode> userModes = new ConcurrentHashMap<>();
    private final ConcurrentHashMap<Long, UserInfo> userInfos = new ConcurrentHashMap<>();
    private final ConcurrentHashMap<Long, Integer> userQuestionCounts = new ConcurrentHashMap<>();

    private UserInfoService userInfoService;
    private SupportRequestService supportRequestService;

    @Autowired
    public NetworkingBot(UserInfoService userInfoService, SupportRequestService supportRequestService) {
        this.userInfoService = userInfoService;
        this.supportRequestService = supportRequestService;
    }

    @Value("${telegram.bot.name}")
    private String botName;

    @Value("${telegram.bot.token}")
    private String botToken;

    public enum DialogMode {
        PROFILE,
        SUPPORT
    }

    @PostConstruct
    private void initializeBot() {
        initialize(botName, botToken);
    }

    @Override
    public void run(String... args) throws Exception {
        TelegramBotsApi telegramBotsApi = new TelegramBotsApi(DefaultBotSession.class);
        telegramBotsApi.registerBot(this);
        setMyCommands();
    }

    private void setMyCommands() {
        List<BotCommand> commands = List.of(
                new BotCommand("/profile", "–ú–æ—è –∞–Ω–∫–µ—Ç–∞"),
                new BotCommand("/help", "–ü–æ–º–æ—â—å")
        );

        try {
            execute(new SetMyCommands(commands, new BotCommandScopeDefault(), null));
        } catch (TelegramApiException e) {
            e.printStackTrace();
        }
    }

    @Override
    public void onUpdateEventReceived(Update update) {
        Long userId = getUserId(update);
        String message = getMessageText(userId);
        String callbackData = getCallbackQueryButtonKey(userId);

        if (message != null && message.startsWith("/")) {
            handleCommand(userId, message);
        } else if (callbackData != null && !callbackData.isEmpty()) {
            handleCallbackQuery(userId, callbackData, update);
        } else if (message != null && !message.isEmpty()) {
            handleDialogMode(userId, message);
        }
    }

    private void handleCommand(Long userId, String command) {
        switch (command) {
            case "/start" -> handleStartCommand(userId);
            case "/profile" -> handleProfileCommand(userId);
            case "/help" -> handleHelpCommand(userId);
            case "/restart" -> handleRestartCommand(userId);
            case "/support" -> handleSupportCommand(userId);
            default -> sendTextMessage(userId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start.");
        }
    }

    private void handleCallbackQuery(Long userId, String callbackData, Update update) {
        switch (callbackData) {
            case "start" -> handleEditStartMessage(userId, update.getCallbackQuery().getMessage().getMessageId());
            case "accepted" -> handleEditInfoMessage(userId, update.getCallbackQuery().getMessage().getMessageId());
            case "toggle_visibility" -> {
                userInfoService.toggleVisibility(userId);
                handleEditProfileCommand(userId, update.getCallbackQuery().getMessage().getMessageId());
            }
            default -> sendTextMessage(userId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start.");
        }
    }

    private void handleSupportCommand(Long userId) {
        Optional<SupportRequest> lastRequest = supportRequestService.getLastSupportRequest(userId);
        if (lastRequest.isPresent()) {
            LocalDateTime lastRequestTime = lastRequest.get().getCreatedAt();
            Duration duration = Duration.between(lastRequestTime, LocalDateTime.now());
            if (duration.toMinutes() < 15) {
                long minutesLeft = 15 - duration.toMinutes();
                sendTextMessage(userId, String.format("–í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∑–∞–ø—Ä–æ—Å –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–µ–¥–∞–≤–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â—ë %d –º–∏–Ω—É—Ç.", minutesLeft));
                return;
            }
        }

        userModes.put(userId, DialogMode.SUPPORT);
        sendTextMessage(userId, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è - 2000 —Å–∏–º–≤–æ–ª–æ–≤. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–∞–∑ –≤ 15 –º–∏–Ω—É—Ç. –ï—Å–ª–∏ –≤—ã –ø–µ—Ä–µ–¥—É–º–∞–ª–∏ –ø–∏—Å–∞—Ç—å, –Ω–∞–∂–º–∏—Ç–µ /profile.");
    }

    private void handleHelpCommand(Long userId) {
        String helpMessage = loadMessage("help");
        sendTextMessage(userId, helpMessage);
    }

    private void handleRestartCommand(Long userId) {
        userInfos.remove(userId);
        userInfoService.deleteUserInfo(userId);
        askFullName(userId);
    }

    private void handleStartCommand(Long userId) {
        //sendPhotoMessage(userId, "start", false);
        sendTextButtonsMessage(userId, loadMessage("start"), "–ü–æ–µ—Ö–∞–ª–∏üöÄ", "start");
    }

    private void handleProfileCommand(Long userId) {
        userInfoService.getUserInfoByUserId(userId).ifPresentOrElse(
                userInfo -> sendUserProfile(userId, userInfo),
                () -> sendTextMessage(userId, "–ê–Ω–∫–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É –∫–æ–º–∞–Ω–¥–æ–π /start.")
        );
    }

    private void handleDialogMode(Long userId, String message) {
        DialogMode currentMode = userModes.get(userId);
        if (currentMode == null) {
            sendTextMessage(userId, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start.");
            return;
        }

        switch (currentMode) {
            case PROFILE -> handleProfileDialog(userId, message);
            case SUPPORT -> handleSupportDialog(userId, message);
        }
    }

    private void handleSupportDialog(Long userId, String message) {
        if (message.length() > 2000) {
            sendTextMessage(userId, "–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –µ–≥–æ –¥–æ 2000 —Å–∏–º–≤–æ–ª–æ–≤.");
            return;
        }

        Optional<SupportRequest> lastRequest = supportRequestService.getLastSupportRequest(userId);
        if (lastRequest.isPresent()) {
            LocalDateTime lastRequestTime = lastRequest.get().getCreatedAt();
            Duration duration = Duration.between(lastRequestTime, LocalDateTime.now());
            if (duration.toMinutes() < 15) {
                long minutesLeft = 15 - duration.toMinutes();
                sendTextMessage(userId, String.format("–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ 15 –º–∏–Ω—É—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â—ë %d –º–∏–Ω—É—Ç.", minutesLeft));
                return;
            }
        }

        SupportRequest supportRequest = new SupportRequest();
        supportRequest.setUserId(userId);
        supportRequest.setMessage(message);
        supportRequest.setRequestStatus(SupportRequest.RequestStatus.OPEN);
        try {
            supportRequestService.saveSupportRequest(supportRequest);
            sendTextMessage(userId, "–í–∞—à –∑–∞–ø—Ä–æ—Å –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –°–ø–∞—Å–∏–±–æ!");
            userModes.remove(userId);
        } catch (Exception e) {
            sendTextMessage(userId, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
        }
    }

    private void handleProfileDialog(Long userId, String message) {
        int questionCount = userQuestionCounts.get(userId);
        UserInfo userInfo = userInfos.get(userId);

        if (message.length() > 255) {
            sendTextMessage(userId, "–í–∞—à –≤–≤–æ–¥ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –µ–≥–æ –¥–æ 255 —Å–∏–º–≤–æ–ª–æ–≤.");
            return;
        }

        switch (questionCount) {
            case 1 -> {
                userInfo.setName(message);
                userQuestionCounts.put(userId, 2);
                sendTextMessage(userId, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –≤–æ–∑—Ä–∞—Å—Ç.");
            }
            case 2 -> {
                userInfo.setAge(message);
                userQuestionCounts.put(userId, 3);
                sendTextMessage(userId, "üëÄ –ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –æ–±—Å—É–¥–∏—Ç—å?");
            }
            case 3 -> {
                userInfo.setDiscussionTopic(message);
                userQuestionCounts.put(userId, 4);
                sendTextMessage(userId, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º —Ñ–∞–∫—Ç–æ–º –æ —Å–µ–±–µ.");
            }
            case 4 -> {
                userInfo.setFunFact(message);
                try {
                    userInfoService.saveUserInfo(userInfo);
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    sendUserProfile(userId, userInfo);
                    userModes.remove(userId); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã
                } catch (Exception e) {
                    sendTextMessage(userId, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
                }
            }
        }
    }

    private void sendUserProfile(Long userId, UserInfo userInfo) {
        String photoUrl = getUserPhotoUrl(userId);
        String userAlias = getUserAlias(userId);
        boolean isAliasValid = userAlias != null && !userAlias.equals("@null");
        String contactInfo = isAliasValid ? userAlias : String.format("<a href=\"tg://user?id=%d\">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>", userId);
        String visibilityStatus = userInfo.getIsVisible() ? "\n‚úÖ –í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞ –≤–∏–¥–Ω–∞." : "\n‚ùå –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤–∞—à—É –∞–Ω–∫–µ—Ç—É –Ω–∏–∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç.";

        String profileMessage = "–í–æ—Ç —Ç–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –ø—Ä–∏—à–ª—ë–º –≤–∞—à–µ–º—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É:\n‚è¨\n" + userInfoService.formatUserProfile(userInfo, contactInfo) + visibilityStatus;

        if (photoUrl != null) {
            sendPhotoMessage(userId, photoUrl, true);
        }
        sendTextButtonsMessage(userId, profileMessage, "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", "accepted", "–°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤–∏–¥–∏–º–æ—Å—Ç–∏", "toggle_visibility");
    }

    private void handleEditStartMessage(Long userId, Integer messageId) {
        String updatedMessage = loadMessage("start") + "\n\n‚û™ –ü–æ–µ—Ö–∞–ª–∏üöÄ";
        editTextMessageWithButtons(userId, messageId, updatedMessage);
        sendTextButtonsMessage(userId, loadMessage("info"), "–ü—Ä–∏–Ω—è—Ç–æ üòä", "accepted");
    }

    private void handleEditInfoMessage(Long userId, Integer messageId) {
        String updatedMessage = loadMessage("info") + "\n\n‚û™ –ü—Ä–∏–Ω—è—Ç–æ ü´°";
        editTextMessageWithButtons(userId, messageId, updatedMessage);
        askFullName(userId);
    }

    private void handleEditProfileCommand(Long userId, Integer messageId) {
        UserInfo userInfo = userInfoService.getUserInfoByUserId(userId).orElseThrow();
        String userAlias = getUserAlias(userId);
        boolean isAliasValid = userAlias != null && !userAlias.equals("@null");
        String contactInfo = isAliasValid ? userAlias : String.format("<a href=\"tg://user?id=%d\">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>", userId);
        String visibilityStatus = userInfo.getIsVisible() ? "\n‚úÖ –í–∞—à–∞ –∞–Ω–∫–µ—Ç–∞ –≤–∏–¥–Ω–∞." : "\n‚ùå –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤–∞—à—É –∞–Ω–∫–µ—Ç—É –Ω–∏–∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç.";

        String updatedMessage = "–í–æ—Ç —Ç–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –ø—Ä–∏—à–ª—ë–º –≤–∞—à–µ–º—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É:\n‚è¨\n" + userInfoService.formatUserProfile(userInfo, contactInfo) + visibilityStatus;

        editTextMessageWithButtons(userId, messageId, updatedMessage, "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", "accepted", "–°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤–∏–¥–∏–º–æ—Å—Ç–∏", "toggle_visibility");
    }

    private void askFullName(Long userId) {
        userModes.put(userId, DialogMode.PROFILE);
        userQuestionCounts.put(userId, 1);

        userInfoService.getUserInfoByUserId(userId).ifPresentOrElse(
                existingUserInfo -> {
                    existingUserInfo.setUserId(userId);
                    userInfos.put(userId, existingUserInfo);
                    sendTextMessage(userId, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è.");
                },
                () -> {
                    UserInfo userInfo = new UserInfo();
                    userInfo.setUserId(userId);
                    userInfos.put(userId, userInfo);
                    sendPhotoMessage(userId, "name", false);
                    sendTextButtonsMessage(userId, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è.");
                }
        );
    }
}
